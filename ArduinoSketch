#include <WiFi.h>
#include <HTTPClient.h>
#include <DHT.h> //Download DHT Sensor Library by Adafruit
#include <ArduinoJson.h> //Download ArduinoJson by Benoit Blanchon

// WiFi credentials
const char* ssid = "XXXXXXXXXXXXXXXXXX";
const char* password = "XXXXXXXXXXXXXXXXXX";
const char* serverUrl = "http://XXXXXXXXXXXXX:8080/api/sensor/data";
// Fill in XXXXX with local ssid, password and server

// Pin definitions
#define DHT_PIN 4              
#define SOIL_MOISTURE_PIN 34   
#define RELAY_PIN 25           //water pump
#define DHT_TYPE DHT22         

// Sensor objects
DHT dht(DHT_PIN, DHT_TYPE);

// Configuration
const int MOISTURE_THRESHOLD = 30; 
const unsigned long READ_INTERVAL = 10000;
const unsigned long PUMP_DURATION = 5000;
const unsigned long PUMP_COOLDOWN = 60000; 

unsigned long lastReadTime = 0;
unsigned long pumpStartTime = 0;
unsigned long lastPumpTime = 0;
bool pumpRunning = false;

void setup() {
  Serial.begin(115200);
  
  // Initialize pins
  pinMode(RELAY_PIN, OUTPUT);
  digitalWrite(RELAY_PIN, LOW);  
  
  dht.begin();
  

  Serial.println();
  Serial.print("Connecting to WiFi");
  WiFi.begin(ssid, password);
  
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  
  Serial.println();
  Serial.println("WiFi connected!");
  Serial.print("IP address: ");
  Serial.println(WiFi.localIP());
  Serial.print("Server URL: ");
  Serial.println(serverUrl);
  
  delay(2000);
}

void loop() {
  unsigned long currentTime = millis();

  managePump(currentTime);
  

  if (currentTime - lastReadTime >= READ_INTERVAL) {
    lastReadTime = currentTime;
    
    // Read sensors
    float temperature = dht.readTemperature();
    float humidity = dht.readHumidity();
    int soilMoisture = readSoilMoisture();
    
 
    if (isnan(temperature) || isnan(humidity)) {
      Serial.println("Failed to read from DHT sensor!");
      temperature = 0;
      humidity = 0;
    }
    

    Serial.println("\n--- Sensor Readings ---");
    Serial.print("Temperature: ");
    Serial.print(temperature);
    Serial.println(" °C");
    Serial.print("Humidity: ");
    Serial.print(humidity);
    Serial.println(" %");
    Serial.print("Soil Moisture: ");
    Serial.print(soilMoisture);
    Serial.println(" %");
    Serial.println("\n--- Sensor Readings ---");
    Serial.print("RAW VALUE: ");
    Serial.println(analogRead(SOIL_MOISTURE_PIN)); 
    Serial.print("Temperature: ");
    Serial.print(temperature);

    

    checkAndWaterIfNeeded(soilMoisture, currentTime);
    

    if (WiFi.status() == WL_CONNECTED) {
      sendDataToServer(temperature, humidity, soilMoisture);
    } else {
      Serial.println("WiFi disconnected! Attempting to reconnect...");
      WiFi.reconnect();
    }
  }
}

int readSoilMoisture() {

  int sensorValue = analogRead(SOIL_MOISTURE_PIN);
  
  const int dryValue = 4095; 
  const int wetValue = 1787; //Calibrated wet value for my DHT sensor. Might be different for the one you're using.
 
  int moisturePercent = map(sensorValue, wetValue, dryValue, 100, 0);
  moisturePercent = constrain(moisturePercent, 0, 100);
  
  return moisturePercent;
}

void checkAndWaterIfNeeded(int soilMoisture, unsigned long currentTime) {

  if (soilMoisture < MOISTURE_THRESHOLD && 
      !pumpRunning && 
      (currentTime - lastPumpTime >= PUMP_COOLDOWN)) {
    
    Serial.println("Soil is dry! Starting water pump...");
    startPump(currentTime);
  }
}

void startPump(unsigned long currentTime) {
  digitalWrite(RELAY_PIN, HIGH); 
  pumpRunning = true;
  pumpStartTime = currentTime;
  lastPumpTime = currentTime;
  Serial.println("PUMP ON");
}

void stopPump() {
  digitalWrite(RELAY_PIN, LOW);  
  pumpRunning = false;
  Serial.println("PUMP OFF");
}

void managePump(unsigned long currentTime) {
  if (pumpRunning && (currentTime - pumpStartTime >= PUMP_DURATION)) {
    stopPump();
  }
}

void sendDataToServer(float temperature, float humidity, int soilMoisture) {
  HTTPClient http;
  
  StaticJsonDocument<200> doc;
  doc["temperature"] = temperature;
  doc["humidity"] = humidity;
  doc["soilMoisture"] = soilMoisture;
  doc["pumpStatus"] = pumpRunning ? "ON" : "OFF";
  
  String jsonPayload;
  serializeJson(doc, jsonPayload);
  // Send HTTP POST request
  http.begin(serverUrl);
  http.addHeader("Content-Type", "application/json");
  
  int httpResponseCode = http.POST(jsonPayload);
  
  if (httpResponseCode > 0) {
    Serial.print("✓ Data sent successfully! Response code: ");
    Serial.println(httpResponseCode);
    String response = http.getString();
    Serial.println("Server response: " + response);
  } else {
    Serial.print("✗ Error sending data. Error code: ");
    Serial.println(httpResponseCode);
    Serial.println("Error: " + http.errorToString(httpResponseCode));
  }
  
  http.end();
}
